---
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../i18n/utils';
import { getDrugs, getLocalizedValue, getCategoryList } from '../lib/data';
import '../styles/tokens.css';

interface Props {
  title: string;
  activeTable?: 'drugs' | 'categories' | 'meta' | 'schema' | 'api';
  activeDrugId?: string;
}

const { title, activeTable = 'drugs', activeDrugId } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const drugs = getDrugs();
const categories = getCategoryList();

const l = (value: any) => getLocalizedValue(value, lang);

// Get active drug for inspector
const activeDrug = activeDrugId ? drugs.find(d => d.id === activeDrugId) : null;

// Define tables
const tables = [
  { id: 'drugs', label: 'drugs', path: '/data/drugs', icon: '◉', count: drugs.length },
  { id: 'categories', label: 'categories', path: '/data/categories', icon: '◈', count: categories.length },
  { id: 'meta', label: 'meta', path: '/meta', icon: '◇', count: 2 },
  { id: 'schema', label: 'schema', path: '/schema', icon: '○', count: 1 },
  { id: 'api', label: 'api', path: '/api-docs', icon: '⬡', count: 3 },
];

// Alternates for SEO (zh-TW must come before zh in regex to match correctly)
const alternates = [
  { lang: 'en', path: Astro.url.pathname.replace(/^\/(zh-TW|zh|ja)/, '') || '/' },
  { lang: 'zh', path: `/zh${Astro.url.pathname.replace(/^\/(zh-TW|zh|ja)/, '')}` },
  { lang: 'ja', path: `/ja${Astro.url.pathname.replace(/^\/(zh-TW|zh|ja)/, '')}` },
  { lang: 'zh-TW', path: `/zh-TW${Astro.url.pathname.replace(/^\/(zh-TW|zh|ja)/, '')}` },
];
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | ADHD-DB</title>
    {alternates.map(({ lang: l, path }) => (
      <link rel="alternate" hreflang={l} href={path} />
    ))}
  </head>
  <body>
    <div class="db-layout">
      <!-- LEFT SIDEBAR -->
      <aside class="sidebar">
        <header class="sidebar-header">
          <a href={getLocalizedPath('/', lang)} class="logo">
            <span class="logo-icon">◆</span>
            <span class="logo-text">ADHD-DB</span>
          </a>
        </header>

        <!-- Table Selector -->
        <div class="table-selector">
          <div class="select-wrapper">
            <select id="table-select" class="table-select">
              {tables.map((table) => (
                <option
                  value={getLocalizedPath(table.path, lang)}
                  selected={activeTable === table.id}
                >
                  {table.icon} {table.label} ({table.count})
                </option>
              ))}
            </select>
            <span class="select-arrow">▼</span>
          </div>
        </div>

        <!-- Table Content -->
        <div class="table-content">
          {activeTable === 'drugs' && (
            <>
              <div class="table-header">
                <span class="col-name">Name</span>
                <span class="col-class">Class</span>
              </div>
              <div class="table-rows">
                {drugs.map((drug) => {
                  const isActive = drug.id === activeDrugId;
                  return (
                    <a
                      href={getLocalizedPath(`/data/drugs/${drug.id}`, lang)}
                      class:list={['table-row', { active: isActive }]}
                    >
                      <span class="row-name">{l(drug.genericName)}</span>
                      <span class="row-class" data-class={drug.drugClass}>
                        {drug.drugClass === 'stimulant' ? t('class.stimulantShort') : t('class.nonStimulantShort')}
                      </span>
                    </a>
                  );
                })}
              </div>
            </>
          )}

          {activeTable === 'categories' && (
            <>
              <div class="table-header">
                <span class="col-name">Name</span>
                <span class="col-class">Class</span>
              </div>
              <div class="table-rows">
                {categories.map((cat) => (
                  <a
                    href={getLocalizedPath(`/data/categories`, lang)}
                    class="table-row"
                  >
                    <span class="row-name">{l(cat.name)}</span>
                    <span class="row-class" data-class={cat.drugClass}>
                      {cat.drugClass === 'stimulant' ? t('class.stimulantShort') : t('class.nonStimulantShort')}
                    </span>
                  </a>
                ))}
              </div>
            </>
          )}

          {activeTable === 'meta' && (
            <>
              <div class="table-header">
                <span class="col-name">File</span>
                <span class="col-type">Type</span>
              </div>
              <div class="table-rows">
                <a href={getLocalizedPath('/meta', lang)} class="table-row">
                  <span class="row-name">regions.yaml</span>
                  <span class="row-type">YAML</span>
                </a>
                <a href={getLocalizedPath('/meta', lang)} class="table-row">
                  <span class="row-name">categories.yaml</span>
                  <span class="row-type">YAML</span>
                </a>
              </div>
            </>
          )}

          {activeTable === 'schema' && (
            <>
              <div class="table-header">
                <span class="col-name">File</span>
                <span class="col-type">Type</span>
              </div>
              <div class="table-rows">
                <a href={getLocalizedPath('/schema', lang)} class="table-row">
                  <span class="row-name">drug-schema.yaml</span>
                  <span class="row-type">YAML</span>
                </a>
              </div>
            </>
          )}

          {activeTable === 'api' && (
            <>
              <div class="table-header">
                <span class="col-name">Endpoint</span>
                <span class="col-type">Method</span>
              </div>
              <div class="table-rows">
                <a href="/api-docs" class="table-row">
                  <span class="row-name">/api/v1/drugs</span>
                  <span class="row-type">GET</span>
                </a>
                <a href="/api-docs" class="table-row">
                  <span class="row-name">/api/v1/drugs/:id</span>
                  <span class="row-type">GET</span>
                </a>
                <a href="/api-docs" class="table-row">
                  <span class="row-name">/api/v1/categories</span>
                  <span class="row-type">GET</span>
                </a>
              </div>
            </>
          )}
        </div>

        <footer class="sidebar-footer">
          <!-- Language Switcher -->
          <div class="footer-section">
            <label class="footer-label">LANGUAGE</label>
            <div class="lang-switcher">
              <a href={alternates.find(a => a.lang === 'en')?.path} class:list={['lang-btn', { active: lang === 'en' }]}>EN</a>
              <a href={alternates.find(a => a.lang === 'zh')?.path} class:list={['lang-btn', { active: lang === 'zh' }]}>中文</a>
              <a href={alternates.find(a => a.lang === 'zh-TW')?.path} class:list={['lang-btn', { active: lang === 'zh-TW' }]}>繁體</a>
              <a href={alternates.find(a => a.lang === 'ja')?.path} class:list={['lang-btn', { active: lang === 'ja' }]}>日本語</a>
            </div>
          </div>

          <!-- Bionic Reading Toggle -->
          <div class="footer-section">
            <label class="footer-label">{t('bionicReading.label')}</label>
            <div class="bionic-toggle-wrapper">
              <button type="button" class="bionic-toggle" id="bionic-toggle" title={t('bionicReading.tooltip')}>
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
                <span class="toggle-label">{t('bionicReading.toggle')}</span>
              </button>
            </div>
          </div>

          <!-- Quick Links -->
          <div class="footer-section">
            <label class="footer-label">TOOLS</label>
            <div class="footer-links">
              <a href={getLocalizedPath('/tools/region-checker', lang)} class="footer-link">Region Checker</a>
              <a href={getLocalizedPath('/travel', lang)} class="footer-link">Travel Guide</a>
            </div>
          </div>

          <!-- Contribute -->
          <div class="footer-section footer-contribute">
            <div class="contribute-text">
              <span class="contribute-icon">◆</span>
              <span>Open source project. Contributions welcome!</span>
            </div>
            <a href="https://github.com/ya-luotao/adhd-db" target="_blank" rel="noopener" class="contribute-btn">
              Contribute on GitHub →
            </a>
          </div>
        </footer>
      </aside>

      <!-- MIDDLE PANEL: Content -->
      <main class="content">
        <slot />
      </main>

      <!-- RIGHT PANEL: Inspector -->
      {activeDrug && (
        <aside class="inspector">
          <header class="inspector-header">
            <span class="inspector-title">Inspector</span>
            <span class="inspector-type">Drug</span>
          </header>

          <div class="inspector-content">
            <!-- Drug Name -->
            <div class="inspector-section">
              <label class="inspector-label">Generic Name</label>
              <div class="inspector-value inspector-name">{l(activeDrug.genericName)}</div>
            </div>

            <!-- Class & Category -->
            <div class="inspector-section inspector-row">
              <div class="inspector-col">
                <label class="inspector-label">Class</label>
                <span class="inspector-badge" data-class={activeDrug.drugClass}>
                  {activeDrug.drugClass}
                </span>
              </div>
              <div class="inspector-col">
                <label class="inspector-label">Category</label>
                <div class="inspector-value-sm">{activeDrug.category}</div>
              </div>
            </div>

            <!-- Approvals Summary - Compact -->
            <div class="inspector-section">
              <label class="inspector-label">Availability</label>
              <div class="inspector-regions">
                {activeDrug.approvals?.map((approval: any) => (
                  <span class:list={['region-chip', { available: approval.available }]}>
                    {approval.region}
                  </span>
                ))}
              </div>
            </div>

            <!-- Actions -->
            <div class="inspector-actions">
              <button class="inspector-action-btn" id="inspector-travel-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>
                Travel Info
              </button>
            </div>
          </div>
        </aside>
      )}
    </div>
  </body>
</html>

<style is:global>
  /* DATABASE LAYOUT - Dossier Style */

  html, body {
    height: 100%;
    overflow: hidden;
    margin: 0;
    padding: 0;
  }

  .db-layout {
    --sidebar-width: 320px;
    --header-height: 48px;
    --accent: #c4a052;
    --accent-dim: rgba(196, 160, 82, 0.12);
    --accent-bold: #a88a3d;
    --danger: #c53030;
    --warning: #b45309;
    --surface: #fdfcfa;
    --surface-alt: #f5f2eb;
    --surface-hover: #edeae3;
    --border: #e8e4dc;
    --border-strong: #d4cfc4;
    --text-primary: #1a1a2e;
    --text-secondary: #4a4a5a;
    --text-muted: #8b8680;

    display: flex;
    height: 100vh;
    background: var(--surface);
    font-family: 'Inter', -apple-system, sans-serif;
  }

  /* SIDEBAR */
  .sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    background: var(--surface-alt);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    height: var(--header-height);
    padding: 0 16px;
    display: flex;
    align-items: center;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    color: var(--text-primary);
    font-weight: 700;
    font-size: 0.9rem;
  }

  .logo-icon {
    color: var(--accent);
    font-size: 1rem;
  }

  .logo-text {
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.02em;
    font-size: 0.85rem;
  }

  /* TABLE SELECTOR */
  .table-selector {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }

  .selector-label {
    display: block;
    font-size: 0.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .select-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .table-select {
    width: 100%;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding: 10px 36px 10px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-primary);
    background: var(--surface-alt);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .table-select:hover {
    border-color: var(--accent);
    background: var(--accent-dim);
  }

  .table-select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-dim);
  }

  .select-arrow {
    position: absolute;
    right: 12px;
    font-size: 0.6rem;
    color: var(--text-muted);
    pointer-events: none;
  }

  /* TABLE CONTENT */
  .table-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .table-header {
    display: grid;
    grid-template-columns: 1fr 50px;
    gap: 8px;
    padding: 8px 16px;
    font-size: 0.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  .col-class, .col-status, .col-type {
    text-align: center;
  }

  .table-rows {
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .table-rows::-webkit-scrollbar {
    width: 6px;
  }

  .table-rows::-webkit-scrollbar-track {
    background: transparent;
  }

  .table-rows::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  .table-row {
    display: grid;
    grid-template-columns: 1fr 50px;
    gap: 8px;
    padding: 10px 16px;
    text-decoration: none;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
    font-size: 0.8rem;
  }

  .table-row:hover {
    background: var(--surface-hover);
  }

  .table-row.active {
    background: var(--accent-dim);
    border-left: 3px solid var(--accent);
    padding-left: 13px;
    font-weight: 600;
  }

  .row-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .row-class {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    font-weight: 600;
    text-align: center;
    padding: 2px 0;
    border-radius: 2px;
    background: var(--surface);
    color: var(--text-muted);
  }

  .row-class[data-class="stimulant"] {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
  }

  .row-class[data-class="non-stimulant"] {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
  }

  .row-type {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    font-weight: 500;
    text-align: center;
    color: var(--text-muted);
  }

  .row-status {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1px;
  }

  .status-num {
    color: var(--accent-bold);
    font-weight: 600;
  }

  .status-sep {
    color: var(--text-muted);
  }

  .status-total {
    color: var(--text-muted);
  }

  .sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: var(--surface);
  }

  .footer-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .footer-label {
    font-size: 0.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
  }

  .lang-switcher {
    display: flex;
    gap: 4px;
  }

  .lang-btn {
    padding: 6px 10px;
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    background: var(--surface-alt);
    border: 1px solid var(--border);
    border-radius: 4px;
    transition: all 0.15s;
  }

  .lang-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .lang-btn.active {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent-bold);
    font-weight: 600;
  }

  .footer-links {
    display: flex;
    gap: 12px;
  }

  .footer-link {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-decoration: none;
    transition: color 0.15s;
  }

  .footer-link:hover {
    color: var(--accent);
  }

  .footer-contribute {
    padding-top: 12px;
    border-top: 1px solid var(--border);
    gap: 10px;
  }

  .contribute-text {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  .contribute-icon {
    color: var(--accent);
    font-size: 0.65rem;
  }

  .contribute-btn {
    display: inline-flex;
    align-items: center;
    padding: 8px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    color: var(--accent-bold);
    text-decoration: none;
    background: var(--accent-dim);
    border: 1px solid var(--accent);
    border-radius: 4px;
    transition: all 0.15s;
  }

  .contribute-btn:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  /* Bionic Reading Toggle */
  .bionic-toggle-wrapper {
    display: flex;
    align-items: center;
  }

  .bionic-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 12px;
    background: var(--surface-alt);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .bionic-toggle:hover {
    border-color: var(--accent);
    background: var(--accent-dim);
  }

  .toggle-track {
    position: relative;
    width: 32px;
    height: 18px;
    background: var(--border);
    border-radius: 9px;
    transition: background 0.2s;
  }

  .toggle-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    transition: transform 0.2s;
  }

  .bionic-toggle.active .toggle-track {
    background: var(--accent);
  }

  .bionic-toggle.active .toggle-thumb {
    transform: translateX(14px);
  }

  .toggle-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.03em;
  }

  .bionic-toggle.active .toggle-label {
    color: var(--accent-bold);
  }

  /* MAIN CONTENT */
  .content {
    flex: 1;
    overflow-y: auto;
    padding: 32px 48px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .content::-webkit-scrollbar {
    width: 8px;
  }

  .content::-webkit-scrollbar-track {
    background: transparent;
  }

  .content::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }

  /* INSPECTOR PANEL */
  .inspector {
    --inspector-width: 280px;
    width: var(--inspector-width);
    min-width: var(--inspector-width);
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .inspector-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--surface-alt);
    border-bottom: 1px solid var(--border);
  }

  .inspector-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
  }

  .inspector-type {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    font-weight: 600;
    color: var(--accent-bold);
    background: var(--accent-dim);
    padding: 3px 8px;
    border-radius: 2px;
    letter-spacing: 0.05em;
  }

  .inspector-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .inspector-section {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .inspector-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .inspector-label {
    display: block;
    font-size: 0.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .inspector-value {
    font-size: 0.85rem;
    color: var(--text-primary);
  }

  .inspector-name {
    font-family: 'Cormorant Garamond', serif;
    font-weight: 600;
    font-size: 1.2rem;
    color: var(--text-primary);
  }

  .inspector-small {
    font-size: 0.75rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .inspector-code {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--accent);
    background: var(--accent-dim);
    padding: 4px 8px;
    border-radius: 4px;
  }

  .inspector-badge {
    display: inline-block;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 4px;
    background: var(--surface-alt);
    color: var(--text-secondary);
  }

  .inspector-badge[data-class="stimulant"] {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
  }

  .inspector-badge[data-class="non-stimulant"] {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
  }

  .inspector-stat {
    font-family: 'DM Mono', monospace;
    font-weight: 600;
    color: var(--accent);
  }

  .inspector-approvals {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .approval-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    background: var(--surface-alt);
    border-radius: 4px;
    font-size: 0.75rem;
  }

  .approval-region {
    font-family: 'DM Mono', monospace;
    font-weight: 600;
    color: var(--text-primary);
  }

  .approval-status {
    font-size: 0.65rem;
    font-weight: 500;
    color: var(--text-muted);
  }

  .approval-status.available {
    color: var(--accent);
  }

  .inspector-brands {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .brand-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
  }

  .brand-row:last-child {
    border-bottom: none;
  }

  .brand-region {
    font-family: 'DM Mono', monospace;
    font-weight: 600;
    color: var(--accent);
    font-size: 0.65rem;
  }

  .brand-names {
    color: var(--text-secondary);
    text-align: right;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .inspector-row {
    display: flex;
    gap: var(--space-4);
  }

  .inspector-col {
    flex: 1;
  }

  .inspector-value-sm {
    font-size: 0.8rem;
    color: var(--text-primary);
  }

  .inspector-regions {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .region-chip {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    font-weight: 600;
    padding: 3px 6px;
    border-radius: 3px;
    background: var(--surface-alt);
    color: var(--text-muted);
    border: 1px solid var(--border);
  }

  .region-chip.available {
    background: rgba(196, 160, 82, 0.1);
    color: var(--accent-bold);
    border-color: var(--accent);
  }

  .inspector-actions {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border);
  }

  .inspector-action-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--accent-bold);
    background: var(--accent-dim);
    border: 1px solid var(--accent);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .inspector-action-btn:hover {
    background: var(--accent);
    color: #fff;
  }

  /* TABLET: Hide inspector */
  @media (max-width: 1200px) {
    .inspector {
      display: none;
    }
  }

  /* MOBILE: Stack layout */
  @media (max-width: 900px) {
    .db-layout {
      flex-direction: column;
    }

    .sidebar {
      width: 100%;
      min-width: 100%;
      height: auto;
      max-height: 40vh;
      border-right: none;
      border-bottom: 1px solid var(--border);
    }

    .content {
      padding: 24px 16px;
    }

    .inspector {
      display: none;
    }
  }

  @media (max-width: 600px) {
    .sidebar {
      max-height: 35vh;
    }

    .table-header {
      display: none;
    }

    .drug-row {
      grid-template-columns: 1fr 40px 50px;
      padding: 8px 12px;
      font-size: 0.8rem;
    }

    .content {
      padding: 16px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Table select functionality
    const tableSelect = document.getElementById('table-select') as HTMLSelectElement;
    if (tableSelect) {
      tableSelect.addEventListener('change', (e) => {
        const target = e.target as HTMLSelectElement;
        if (target.value) {
          window.location.href = target.value;
        }
      });
    }

    // Bionic Reading Toggle
    const bionicToggle = document.getElementById('bionic-toggle');
    const BIONIC_STORAGE_KEY = 'adhd-db-bionic-reading';

    // Function to apply bionic reading to text content
    function applyBionicReading(enabled: boolean) {
      if (enabled) {
        document.body.classList.add('bionic-reading');
        // Process all bionic-content elements
        document.querySelectorAll('.bionic-content p').forEach((p) => {
          if (!p.getAttribute('data-original')) {
            p.setAttribute('data-original', p.innerHTML);
          }
          const text = p.getAttribute('data-original') || p.textContent || '';
          p.innerHTML = convertToBionic(text);
        });
      } else {
        document.body.classList.remove('bionic-reading');
        // Restore original content
        document.querySelectorAll('.bionic-content p').forEach((p) => {
          const original = p.getAttribute('data-original');
          if (original) {
            p.innerHTML = original;
          }
        });
      }
    }

    // Convert text to bionic reading format
    function convertToBionic(text: string): string {
      // Split into words and process each
      return text.replace(/\b(\w+)\b/g, (word) => {
        if (word.length <= 1) return word;
        // Bold the first half of the word (roughly)
        const boldLength = Math.ceil(word.length / 2);
        const boldPart = word.slice(0, boldLength);
        const normalPart = word.slice(boldLength);
        return `<strong>${boldPart}</strong>${normalPart}`;
      });
    }

    // Initialize bionic reading state from localStorage
    function initBionicReading() {
      const stored = localStorage.getItem(BIONIC_STORAGE_KEY);
      const isEnabled = stored === 'true';

      if (bionicToggle) {
        if (isEnabled) {
          bionicToggle.classList.add('active');
        }
        applyBionicReading(isEnabled);
      }
    }

    // Toggle bionic reading
    if (bionicToggle) {
      bionicToggle.addEventListener('click', () => {
        const isActive = bionicToggle.classList.toggle('active');
        localStorage.setItem(BIONIC_STORAGE_KEY, String(isActive));
        applyBionicReading(isActive);
      });
    }

    // Initialize on page load
    initBionicReading();

    // Re-apply bionic reading when new content is loaded (for SPA-like behavior)
    const observer = new MutationObserver((mutations) => {
      const stored = localStorage.getItem(BIONIC_STORAGE_KEY);
      if (stored === 'true') {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              const el = node as Element;
              el.querySelectorAll('.bionic-content p').forEach((p) => {
                if (!p.getAttribute('data-original')) {
                  p.setAttribute('data-original', p.innerHTML);
                  p.innerHTML = convertToBionic(p.innerHTML);
                }
              });
            }
          });
        });
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  });
</script>

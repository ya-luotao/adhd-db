---
import DatabaseLayout from '../../../layouts/DatabaseLayout.astro';
import { getDrugs, getLocalizedValue } from '../../../lib/data';
import { getLangFromUrl, useTranslations } from '../../../i18n/utils';

// Prerender at build time (required for Cloudflare Workers)
export const prerender = true;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const drugs = getDrugs();

const l = (value: any) => getLocalizedValue(value, lang);

// Calculate stats
const stimulants = drugs.filter(d => d.drugClass === 'stimulant');
const nonStimulants = drugs.filter(d => d.drugClass === 'non-stimulant');
const allRegions = [...new Set(drugs.flatMap(d => d.approvals?.map((a: any) => a.region) || []))];
const totalApprovals = drugs.reduce((acc, d) => acc + (d.approvals?.filter((a: any) => a.available).length || 0), 0);
---

<DatabaseLayout title={t('drugs.title')} activeTable="drugs">
  <div class="index-page">
    <header class="page-header">
      <h1 class="page-title">drugs</h1>
      <p class="page-desc">ADHD medication database with multi-region regulatory data</p>
    </header>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-value">{drugs.length}</span>
        <span class="stat-label">Total Drugs</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{stimulants.length}</span>
        <span class="stat-label">Stimulants</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{nonStimulants.length}</span>
        <span class="stat-label">Non-Stimulants</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{allRegions.length}</span>
        <span class="stat-label">Regions</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{totalApprovals}</span>
        <span class="stat-label">Approvals</span>
      </div>
    </div>

    <!-- Data Table -->
    <section class="data-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="title-marker"></span>
          All Records
          <span class="record-count">{drugs.length} rows</span>
        </h2>
      </div>

      <div class="data-table">
        <div class="table-head">
          <span class="th col-id">id</span>
          <span class="th col-name">genericName</span>
          <span class="th col-class">drugClass</span>
          <span class="th col-category">category</span>
          <span class="th col-approvals">approvals</span>
        </div>
        <div class="table-body">
          {drugs.map((drug, idx) => {
            const availableCount = drug.approvals?.filter((a: any) => a.available).length || 0;
            const totalRegions = drug.approvals?.length || 0;
            return (
              <div class="table-row" data-idx={idx}>
                <span class="td col-id">
                  <code>{drug.id}</code>
                </span>
                <span class="td col-name">{l(drug.genericName)}</span>
                <span class="td col-class">
                  <span class="class-badge" data-class={drug.drugClass}>
                    {drug.drugClass}
                  </span>
                </span>
                <span class="td col-category">{drug.category}</span>
                <span class="td col-approvals">
                  <span class="approval-stat">
                    <span class="avail">{availableCount}</span>
                    <span class="sep">/</span>
                    <span class="total">{totalRegions}</span>
                  </span>
                </span>
              </div>
            );
          })}
        </div>
      </div>
    </section>

    <!-- Schema Preview -->
    <section class="data-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="title-marker"></span>
          Schema Fields
        </h2>
      </div>
      <div class="schema-preview">
        <code class="field"><span class="key">id</span>: string</code>
        <code class="field"><span class="key">genericName</span>: LocalizedString</code>
        <code class="field"><span class="key">drugClass</span>: "stimulant" | "non-stimulant"</code>
        <code class="field"><span class="key">category</span>: string</code>
        <code class="field"><span class="key">brandNames</span>: Record&lt;Region, string[]&gt;</code>
        <code class="field"><span class="key">approvals</span>: Approval[]</code>
        <code class="field"><span class="key">formulations</span>: Formulation[]</code>
        <code class="field"><span class="key">pharmacology</span>: Pharmacology</code>
        <code class="field"><span class="key">sideEffects</span>: SideEffect[]</code>
      </div>
    </section>
  </div>
</DatabaseLayout>

<style>
  .index-page {
    max-width: 1000px;
  }

  .page-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .page-title {
    font-family: 'DM Mono', monospace;
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #111827;
  }

  .page-desc {
    color: #6b7280;
    font-size: 0.95rem;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 2.5rem;
  }

  .stat-card {
    background: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .stat-value {
    font-family: 'DM Mono', monospace;
    font-size: 1.75rem;
    font-weight: 600;
    color: #00a86b;
  }

  .stat-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Data Section */
  .data-section {
    margin-bottom: 2.5rem;
  }

  .section-header {
    margin-bottom: 1rem;
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #4b5563;
  }

  .title-marker {
    width: 4px;
    height: 16px;
    background: #00a86b;
    border-radius: 1px;
  }

  .record-count {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    font-weight: 500;
    color: #9ca3af;
    background: #f3f4f6;
    padding: 2px 8px;
    border-radius: 3px;
    margin-left: auto;
  }

  /* Data Table */
  .data-table {
    background: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
  }

  .table-head {
    display: grid;
    grid-template-columns: 180px 1fr 100px 140px 80px;
    gap: 8px;
    padding: 10px 16px;
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
  }

  .th {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: lowercase;
    color: #9ca3af;
  }

  .table-body {
    max-height: 400px;
    overflow-y: auto;
  }

  .table-row {
    display: grid;
    grid-template-columns: 180px 1fr 100px 140px 80px;
    gap: 8px;
    padding: 10px 16px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.8rem;
    transition: background 0.1s;
  }

  .table-row:last-child {
    border-bottom: none;
  }

  .table-row:hover {
    background: #fff;
  }

  .td {
    display: flex;
    align-items: center;
  }

  .col-id code {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: #00a86b;
    background: rgba(0, 168, 107, 0.1);
    padding: 2px 6px;
    border-radius: 3px;
  }

  .col-name {
    font-weight: 500;
    color: #111827;
  }

  .class-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 3px;
    background: #f3f4f6;
    color: #6b7280;
  }

  .class-badge[data-class="stimulant"] {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
  }

  .class-badge[data-class="non-stimulant"] {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
  }

  .col-category {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .approval-stat {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .approval-stat .avail {
    color: #00a86b;
    font-weight: 600;
  }

  .approval-stat .sep {
    color: #d1d5db;
  }

  .approval-stat .total {
    color: #9ca3af;
  }

  /* Schema Preview */
  .schema-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 1rem;
    background: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
  }

  .schema-preview .field {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 4px 10px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    color: #4b5563;
  }

  .schema-preview .key {
    color: #00a86b;
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .table-head,
    .table-row {
      grid-template-columns: 1fr 80px 60px;
    }

    .col-id,
    .col-category {
      display: none;
    }
  }
</style>

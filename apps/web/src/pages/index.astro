---
import Layout from '../layouts/Layout.astro';
import { getDrugs, getDataTypes, getLocalizedValue } from '../lib/data';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const l = (value: any) => getLocalizedValue(value, lang);

const drugs = getDrugs();
const dataTypes = getDataTypes();
const stimulants = drugs.filter(d => d.drugClass === 'stimulant');
const nonStimulants = drugs.filter(d => d.drugClass === 'non-stimulant');
---

<Layout title={t('nav.home')}>
  <h1>{t('home.title')}</h1>

  <p class="page-description">
    {t('home.description')}
  </p>

  <div class="grid">
    <div class="card">
      <h3>{t('home.schema.title')}</h3>
      <p>{t('home.schema.desc')}</p>
      <a href={getLocalizedPath('/schema', lang)}>{t('home.schema.link')} &rarr;</a>
    </div>

    <div class="card">
      <h3>{t('home.meta.title')}</h3>
      <p>{t('home.meta.desc')}</p>
      <a href={getLocalizedPath('/meta', lang)}>{t('home.meta.link')} &rarr;</a>
    </div>

    <div class="card">
      <h3>{t('home.data.title')}</h3>
      <p>{dataTypes.reduce((acc, t) => acc + t.count, 0)} {t('home.entries')} {dataTypes.length} {t('home.types')}</p>
      <a href={getLocalizedPath('/data', lang)}>{t('home.data.link')} &rarr;</a>
    </div>
  </div>

  <h2>{t('home.stats')}</h2>

  <div class="grid">
    <div class="card stat-card">
      <h3>{t('home.totalDrugs')}</h3>
      <p class="stat-number">{drugs.length}</p>
    </div>
    <div class="card stat-card">
      <h3>{t('home.stimulants')}</h3>
      <p class="stat-number stat-stimulant">{stimulants.length}</p>
    </div>
    <div class="card stat-card">
      <h3>{t('home.nonStimulants')}</h3>
      <p class="stat-number stat-non-stimulant">{nonStimulants.length}</p>
    </div>
  </div>

  <h2>{t('home.allDrugs')}</h2>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>{t('table.drug')}</th>
          <th>{t('table.class')}</th>
          <th>US</th>
          <th>CN</th>
          <th>EU</th>
          <th>JP</th>
        </tr>
      </thead>
      <tbody>
        {drugs.map(drug => {
          const getAvailability = (region: string) => {
            const approval = drug.approvals?.find(a => a.region === region);
            return approval?.available ? '✓' : '✗';
          };
          return (
            <tr>
              <td>
                <a href={getLocalizedPath(`/data/drugs/${drug.id}`, lang)}>{l(drug.genericName)}</a>
              </td>
              <td>
                <span class={`tag ${drug.drugClass}`}>{l(drug.drugClassLabel) || drug.drugClass}</span>
              </td>
              <td class="availability">{getAvailability('US')}</td>
              <td class="availability">{getAvailability('CN')}</td>
              <td class="availability">{getAvailability('EU')}</td>
              <td class="availability">{getAvailability('JP')}</td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <!-- Mobile-friendly drug cards -->
  <div class="drug-cards-mobile">
    {drugs.map(drug => {
      const regions = drug.approvals?.filter(a => a.available).map(a => a.region) || [];
      return (
        <a href={getLocalizedPath(`/data/drugs/${drug.id}`, lang)} class="card drug-card-mobile">
          <div class="drug-card-header">
            <h3>{l(drug.genericName)}</h3>
            <span class={`tag ${drug.drugClass}`}>{l(drug.drugClassLabel) || drug.drugClass}</span>
          </div>
          <div class="drug-card-regions">
            {regions.map(region => (
              <span class="tag available">{region}</span>
            ))}
            {regions.length === 0 && <span class="no-regions">{t('data.noData')}</span>}
          </div>
        </a>
      );
    })}
  </div>
</Layout>

<style>
  .page-description {
    margin-bottom: var(--space-8);
    color: var(--color-text-tertiary);
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
  }

  .stat-card {
    text-align: center;
  }

  .stat-number {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    margin: 0;
  }

  .stat-stimulant {
    color: var(--color-stimulant-text);
  }

  .stat-non-stimulant {
    color: var(--color-non-stimulant-text);
  }

  .table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .availability {
    text-align: center;
    font-size: var(--text-lg);
  }

  /* Mobile drug cards - hidden by default */
  .drug-cards-mobile {
    display: none;
  }

  .drug-card-mobile {
    text-decoration: none;
    color: inherit;
  }

  .drug-card-mobile:hover {
    text-decoration: none;
  }

  .drug-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
  }

  .drug-card-header h3 {
    margin: 0;
    color: var(--color-primary);
    font-size: var(--text-lg);
  }

  .drug-card-regions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
  }

  .no-regions {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }

  /* Mobile responsive */
  @media (max-width: 639px) {
    .page-description {
      font-size: var(--text-base);
      margin-bottom: var(--space-6);
    }

    .stat-number {
      font-size: var(--text-3xl);
    }

    .table-wrapper {
      display: none;
    }

    .drug-cards-mobile {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
  }
</style>

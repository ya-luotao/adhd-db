---
import Layout from '../../../layouts/Layout.astro';
import { getDrugs, getRegions, getLocalizedValue, getLocalizedArray, inferTravelStatus, getCrossBorderRule, type Drug, type TravelStatus } from '../../../lib/data';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../../../i18n/utils';

// Prerender all travel routes at build time
export const prerender = true;

export function getStaticPaths() {
  const drugs = getDrugs();
  const regionsData = getRegions();
  const regionCodes = Object.keys(regionsData.regions);

  const paths: { params: { route: string } }[] = [];

  for (const drug of drugs) {
    for (const fromRegion of regionCodes) {
      for (const toRegion of regionCodes) {
        if (fromRegion !== toRegion) {
          paths.push({
            params: {
              route: `${drug.id}-from-${fromRegion.toLowerCase()}-to-${toRegion.toLowerCase()}`
            }
          });
        }
      }
    }
  }

  return paths;
}

const drugs = getDrugs();
const regionsData = getRegions();
const regionCodes = Object.keys(regionsData.regions);

// Parse route: drug-id-from-ORIGIN-to-DEST
const routeParam = Astro.params.route || '';
const routeMatch = routeParam.match(/^(.+)-from-([a-z]{2}(?:-[a-z]{2})?)-to-([a-z]{2}(?:-[a-z]{2})?)$/i);

if (!routeMatch) {
  return Astro.redirect('/ja/travel');
}

const [, drugId, fromRegionParam, toRegionParam] = routeMatch;
const fromRegion = fromRegionParam.toUpperCase();
const toRegion = toRegionParam.toUpperCase();

// Validate drug and regions exist
const drug = drugs.find((d: Drug) => d.id === drugId);
if (!drug || !regionCodes.includes(fromRegion) || !regionCodes.includes(toRegion) || fromRegion === toRegion) {
  return Astro.redirect('/ja/travel');
}

const regions = regionsData;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Helper to get localized drug field
const l = (value: any) => getLocalizedValue(value, lang);
const la = (value: any) => getLocalizedArray(value, lang);

// Get region details
const fromRegionData = regions.regions[fromRegion];
const toRegionData = regions.regions[toRegion];
const fromRegionName = fromRegionData?.name || fromRegion;
const toRegionName = toRegionData?.name || toRegion;

// Get drug name
const drugName = l(drug.genericName);

// Get travel status
const travelInfo = inferTravelStatus(drug, fromRegion, toRegion);
const explicitRule = getCrossBorderRule(drug, fromRegion, toRegion);

// Get approvals
const fromApproval = drug.approvals?.find((a: any) => a.region === fromRegion);
const toApproval = drug.approvals?.find((a: any) => a.region === toRegion);

// Status colors
const statusColors: Record<TravelStatus, string> = {
  allowed: 'var(--color-success)',
  restricted: 'var(--color-warning)',
  requires_permit: 'var(--color-warning)',
  prohibited: 'var(--color-danger)',
};

const statusBgColors: Record<TravelStatus, string> = {
  allowed: 'var(--color-success-light, #d4edda)',
  restricted: 'var(--color-warning-light, #fff3cd)',
  requires_permit: 'var(--color-warning-light, #fff3cd)',
  prohibited: 'var(--color-danger-light, #f8d7da)',
};

// Template helper for translations with placeholders
function tpl(key: string, replacements: Record<string, string>): string {
  let result = t(key);
  for (const [placeholder, value] of Object.entries(replacements)) {
    result = result.replace(`{${placeholder}}`, value);
  }
  return result;
}

// Page title and meta
const pageTitle = tpl('travelPage.title', { drug: drugName, from: fromRegionName, to: toRegionName });
const metaDescription = tpl('travelPage.metaDescription', { drug: drugName, from: fromRegionName, to: toRegionName });

// Get related routes (same drug, different destinations from same origin)
const relatedRoutes = regionCodes
  .filter(r => r !== fromRegion && r !== toRegion)
  .map(r => ({
    to: r,
    toName: regions.regions[r]?.name || r,
    path: `/travel/${drug.id}-from-${fromRegion.toLowerCase()}-to-${r.toLowerCase()}`,
  }));

// Get other drugs for same route
const otherDrugs = drugs
  .filter((d: Drug) => d.id !== drug.id)
  .map((d: Drug) => ({
    id: d.id,
    name: l(d.genericName),
    path: `/travel/${d.id}-from-${fromRegion.toLowerCase()}-to-${toRegion.toLowerCase()}`,
  }));
---

<Layout title={pageTitle} description={metaDescription}>
  <nav class="breadcrumb">
    <a href={getLocalizedPath('/', lang)}>{t('nav.home')}</a>
    <span class="separator">/</span>
    <a href={getLocalizedPath('/travel', lang)}>{t('travelPage.allRoutes')}</a>
    <span class="separator">/</span>
    <span>{drugName}: {fromRegion} → {toRegion}</span>
  </nav>

  <header class="travel-header">
    <h1>{tpl('travelPage.heading', { drug: drugName })}</h1>
    <p class="subtitle">{tpl('travelPage.subtitle', { from: fromRegionName, to: toRegionName })}</p>
  </header>

  <!-- Status Summary Card -->
  <div class="status-card" style={`border-left: 4px solid ${statusColors[travelInfo.status]}; background: ${statusBgColors[travelInfo.status]}`}>
    <div class="status-header">
      <h2>{t('travelPage.summary')}</h2>
      <span class="status-badge" style={`background: ${statusColors[travelInfo.status]}`}>
        {t(`travel.status.${travelInfo.status}`)}
      </span>
    </div>

    <div class="route-visual">
      <div class="region-box">
        <span class="region-code">{fromRegion}</span>
        <span class="region-name">{fromRegionName}</span>
      </div>
      <div class="arrow">→</div>
      <div class="region-box">
        <span class="region-code">{toRegion}</span>
        <span class="region-name">{toRegionName}</span>
      </div>
    </div>

    {travelInfo.inferred && (
      <div class="inferred-warning">
        <strong>⚠️</strong> {t('travelPage.inferredWarning')}
      </div>
    )}
  </div>

  <div class="content-grid">
    <!-- Left Column -->
    <div class="main-content">
      <!-- Requirements -->
      {explicitRule && (
        <section class="card">
          <h3>{t('travelPage.requirements')}</h3>

          {la(explicitRule.requirements).length > 0 && (
            <ul class="requirements-list">
              {la(explicitRule.requirements).map((req: string) => (
                <li>{req}</li>
              ))}
            </ul>
          )}

          {explicitRule.maxSupply && (
            <div class="info-item">
              <strong>{t('travelPage.maxSupply')}:</strong>
              <span>{explicitRule.maxSupply}</span>
            </div>
          )}

          {explicitRule.notes && (
            <div class="notes">
              <strong>{t('travelPage.importantNotes')}:</strong>
              <p>{l(explicitRule.notes)}</p>
            </div>
          )}

          {explicitRule.sources && explicitRule.sources.length > 0 && (
            <div class="sources">
              <strong>{t('travelPage.officialSources')}:</strong>
              <ul>
                {explicitRule.sources.map((src: string) => (
                  <li><a href={src} target="_blank" rel="noopener noreferrer">{new URL(src).hostname}</a></li>
                ))}
              </ul>
            </div>
          )}
        </section>
      )}

      <!-- General Documentation -->
      {drug.travelRules?.requiredDocumentation && drug.travelRules.requiredDocumentation.length > 0 && (
        <section class="card">
          <h3>{t('travelPage.documentation')}</h3>
          <ul class="doc-list">
            {drug.travelRules.requiredDocumentation.map((doc: any) => (
              <li>
                <strong>{l(doc.typeLabel)}</strong>
                {doc.notes && <span class="doc-notes"> - {l(doc.notes)}</span>}
              </li>
            ))}
          </ul>
        </section>
      )}

      <!-- General Advice -->
      {drug.travelRules?.generalAdvice && (
        <section class="card">
          <h3>{t('travel.generalAdvice')}</h3>
          <p>{l(drug.travelRules.generalAdvice)}</p>
        </section>
      )}
    </div>

    <!-- Right Column - Sidebar -->
    <aside class="sidebar">
      <!-- Drug Info Card -->
      <div class="card drug-info">
        <h3>{drugName}</h3>
        <div class="drug-tags">
          <span class={`tag ${drug.drugClass}`}>{l(drug.drugClassLabel) || drug.drugClass}</span>
          {drug.controlledSubstance && (
            <span class="tag tag-controlled">{t('common.controlled')}</span>
          )}
        </div>
        <a href={getLocalizedPath(`/data/drugs/${drug.id}`, lang)} class="view-drug-link">
          View full drug info →
        </a>
      </div>

      <!-- Origin Region Info -->
      <div class="card region-info">
        <h4>{tpl('travelPage.availabilityOrigin', { region: fromRegionName })}</h4>
        <div class="availability-badge {fromApproval?.available ? 'available' : 'unavailable'}">
          {fromApproval?.available ? t('travelPage.available') : t('travelPage.notAvailable')}
        </div>
        {drug.brandNames?.[fromRegion]?.length > 0 && (
          <div class="brand-names">
            <strong>{t('travelPage.brandNames')}:</strong>
            <span>{drug.brandNames[fromRegion].join(', ')}</span>
          </div>
        )}
        {drug.schedule?.[fromRegion] && (
          <div class="schedule">
            <strong>{t('travelPage.schedule')}:</strong>
            <span>{drug.schedule[fromRegion]}</span>
          </div>
        )}
      </div>

      <!-- Destination Region Info -->
      <div class="card region-info">
        <h4>{tpl('travelPage.availabilityDest', { region: toRegionName })}</h4>
        <div class={`availability-badge ${toApproval?.available ? 'available' : 'unavailable'}`}>
          {toApproval?.available ? t('travelPage.available') : t('travelPage.notAvailable')}
        </div>
        {drug.brandNames?.[toRegion]?.length > 0 && (
          <div class="brand-names">
            <strong>{t('travelPage.brandNames')}:</strong>
            <span>{drug.brandNames[toRegion].join(', ')}</span>
          </div>
        )}
        {drug.schedule?.[toRegion] && (
          <div class="schedule">
            <strong>{t('travelPage.schedule')}:</strong>
            <span>{drug.schedule[toRegion]}</span>
          </div>
        )}
      </div>
    </aside>
  </div>

  <!-- Related Routes -->
  <section class="related-section">
    <h3>{tpl('travelPage.relatedRoutes', { drug: drugName })}</h3>
    <div class="related-grid">
      {relatedRoutes.slice(0, 6).map(route => (
        <a href={getLocalizedPath(route.path, lang)} class="related-link">
          {fromRegionName} → {route.toName}
        </a>
      ))}
    </div>
  </section>

  <!-- Other Drugs Same Route -->
  <section class="related-section">
    <h3>{t('travelPage.otherDrugs')}</h3>
    <div class="related-grid">
      {otherDrugs.slice(0, 6).map((d: { id: string; name: string; path: string }) => (
        <a href={getLocalizedPath(d.path, lang)} class="related-link">
          {d.name}
        </a>
      ))}
    </div>
  </section>

  <!-- Disclaimer -->
  <div class="disclaimer-box">
    <p>{t('travelPage.disclaimer')}</p>
  </div>

  <!-- Navigation -->
  <nav class="bottom-nav">
    <a href={getLocalizedPath('/tools/region-checker', lang)} class="btn btn-secondary">
      ← {t('travelPage.backToChecker')}
    </a>
    <a href={getLocalizedPath('/travel', lang)} class="btn btn-primary">
      {t('travelPage.allRoutes')}
    </a>
  </nav>
</Layout>

<style>
  .breadcrumb {
    margin-bottom: var(--space-4);
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }

  .breadcrumb a {
    color: var(--color-primary);
  }

  .breadcrumb .separator {
    margin: 0 var(--space-2);
  }

  .travel-header {
    margin-bottom: var(--space-6);
  }

  .travel-header h1 {
    margin-bottom: var(--space-2);
  }

  .subtitle {
    font-size: var(--text-xl);
    color: var(--color-text-secondary);
  }

  .status-card {
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-6);
  }

  .status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
  }

  .status-header h2 {
    margin: 0;
    font-size: var(--text-lg);
  }

  .status-badge {
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    color: white;
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    font-size: var(--text-sm);
  }

  .route-visual {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    padding: var(--space-4);
    background: rgba(255, 255, 255, 0.5);
    border-radius: var(--radius-md);
  }

  .region-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    background: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }

  .region-code {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-primary);
  }

  .region-name {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .arrow {
    font-size: var(--text-2xl);
    color: var(--color-text-tertiary);
  }

  .inferred-warning {
    margin-top: var(--space-4);
    padding: var(--space-3);
    background: rgba(255, 255, 255, 0.7);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .content-grid {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: var(--space-6);
    margin-bottom: var(--space-8);
  }

  @media (max-width: 768px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
  }

  .card {
    background: var(--color-bg-secondary);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
  }

  .card h3, .card h4 {
    margin-top: 0;
    margin-bottom: var(--space-3);
  }

  .requirements-list {
    margin: 0 0 var(--space-4) var(--space-6);
  }

  .requirements-list li {
    margin-bottom: var(--space-2);
  }

  .info-item {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
  }

  .notes {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
  }

  .notes p {
    margin: var(--space-2) 0 0;
    color: var(--color-text-secondary);
  }

  .sources {
    margin-top: var(--space-4);
    font-size: var(--text-sm);
  }

  .sources ul {
    margin: var(--space-2) 0 0 var(--space-4);
  }

  .doc-list {
    margin: 0 0 0 var(--space-6);
  }

  .doc-list li {
    margin-bottom: var(--space-2);
  }

  .doc-notes {
    color: var(--color-text-tertiary);
  }

  .drug-info {
    text-align: center;
  }

  .drug-info h3 {
    margin-bottom: var(--space-2);
  }

  .drug-tags {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
  }

  .tag {
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
  }

  .tag.stimulant {
    background: var(--color-warning-light, #fff3cd);
    color: var(--color-warning-700, #856404);
  }

  .tag.non-stimulant {
    background: var(--color-success-light, #d4edda);
    color: var(--color-success-700, #155724);
  }

  .tag-controlled {
    background: var(--color-danger-light, #f8d7da);
    color: var(--color-danger-700, #721c24);
  }

  .view-drug-link {
    font-size: var(--text-sm);
    color: var(--color-primary);
  }

  .region-info h4 {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .availability-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    margin-bottom: var(--space-2);
  }

  .availability-badge.available {
    background: var(--color-success-light, #d4edda);
    color: var(--color-success-700, #155724);
  }

  .availability-badge.unavailable {
    background: var(--color-danger-light, #f8d7da);
    color: var(--color-danger-700, #721c24);
  }

  .brand-names, .schedule {
    font-size: var(--text-sm);
    margin-top: var(--space-2);
  }

  .related-section {
    margin-bottom: var(--space-6);
  }

  .related-section h3 {
    margin-bottom: var(--space-3);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: var(--space-3);
  }

  .related-link {
    display: block;
    padding: var(--space-3);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    font-size: var(--text-sm);
    transition: background 0.2s;
  }

  .related-link:hover {
    background: var(--color-bg-tertiary);
  }

  .disclaimer-box {
    padding: var(--space-4);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-6);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .disclaimer-box p {
    margin: 0;
  }

  .bottom-nav {
    display: flex;
    justify-content: space-between;
    gap: var(--space-4);
  }

  .btn {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: var(--font-medium);
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
  }

  .btn:hover {
    opacity: 0.9;
  }
</style>

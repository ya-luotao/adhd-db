---
import Layout from '../../layouts/Layout.astro';
import { getDrugs, getDataTypes } from '../../lib/data';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const drugs = getDrugs();
const dataTypes = getDataTypes();
const stimulants = drugs.filter(d => d.drugClass === 'stimulant');
const nonStimulants = drugs.filter(d => d.drugClass === 'non-stimulant');
---

<Layout title={t('nav.home')}>
  <h1>{t('home.title')}</h1>

  <p style="margin-bottom: 2rem; color: #666;">
    {t('home.description')}
  </p>

  <div class="grid">
    <div class="card">
      <h3>{t('home.schema.title')}</h3>
      <p>{t('home.schema.desc')}</p>
      <a href={getLocalizedPath('/schema', lang)}>{t('home.schema.link')} &rarr;</a>
    </div>

    <div class="card">
      <h3>{t('home.meta.title')}</h3>
      <p>{t('home.meta.desc')}</p>
      <a href={getLocalizedPath('/meta', lang)}>{t('home.meta.link')} &rarr;</a>
    </div>

    <div class="card">
      <h3>{t('home.data.title')}</h3>
      <p>{dataTypes.reduce((acc, t) => acc + t.count, 0)} {t('home.entries')} {dataTypes.length} {t('home.types')}</p>
      <a href={getLocalizedPath('/data', lang)}>{t('home.data.link')} &rarr;</a>
    </div>
  </div>

  <h2>{t('home.stats')}</h2>

  <div class="grid">
    <div class="card">
      <h3>{t('home.totalDrugs')}</h3>
      <p style="font-size: 2rem; font-weight: bold;">{drugs.length}</p>
    </div>
    <div class="card">
      <h3>{t('home.stimulants')}</h3>
      <p style="font-size: 2rem; font-weight: bold; color: #991b1b;">{stimulants.length}</p>
    </div>
    <div class="card">
      <h3>{t('home.nonStimulants')}</h3>
      <p style="font-size: 2rem; font-weight: bold; color: #1e40af;">{nonStimulants.length}</p>
    </div>
  </div>

  <h2>{t('home.allDrugs')}</h2>

  <table>
    <thead>
      <tr>
        <th>{t('table.drug')}</th>
        <th>{t('table.class')}</th>
        <th>US</th>
        <th>CN</th>
        <th>EU</th>
        <th>JP</th>
      </tr>
    </thead>
    <tbody>
      {drugs.map(drug => {
        const getAvailability = (region: string) => {
          const approval = drug.approvals?.find(a => a.region === region);
          return approval?.available ? '✓' : '✗';
        };
        return (
          <tr>
            <td>
              <a href={getLocalizedPath(`/data/drugs/${drug.id}`, lang)}>{drug.genericName}</a>
            </td>
            <td>
              <span class={`tag ${drug.drugClass}`}>{drug.drugClass}</span>
            </td>
            <td>{getAvailability('US')}</td>
            <td>{getAvailability('CN')}</td>
            <td>{getAvailability('EU')}</td>
            <td>{getAvailability('JP')}</td>
          </tr>
        );
      })}
    </tbody>
  </table>
</Layout>
